sudo: required

language: generic

dist: trusty

python:
  - 2.7
  - 3.4
  - 3.5

addons:
  apt:
    packages: 
      - gfortran


before_install:
  # Python
  - wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh
  - chmod +x miniconda.sh
  - ./miniconda.sh -b
  - export PATH=/home/travis/miniconda2/bin:$PATH
  - conda update --yes conda
  
  # CDF
  - wget -r -l1 -np -nd -nc http://cdaweb.gsfc.nasa.gov/pub/software/cdf/dist/latest-release/linux/ -A cdf*-dist-all.tar.gz
  - tar xf cdf*-dist-all.tar.gz
  - cd cdf*dist
  - make OS=linux ENV=gnu all
  - sudo make INSTALLDIR=/usr/local/cdf install
  - cd ..

install:
  - conda create --yes -n test python=$TRAVIS_PYTHON_VERSION
  - source activate test
  # we use conda to prevent compiling big packages
  - conda install --yes numpy scipy astropy ephem numexpr scikit-image pillow matplotlib basemap docutils pip
  # OpenCV only supports Python 3 in OpenCV 3.x
  - if [[ $TRAVIS_PYTHON_VERSION == 2.7 ]]; then
      conda install --yes opencv ;
    fi
  - travis_retry pip install -r dev-requirements.txt
  - python setup.py sdist 
  - pip install dist/*.tar.gz
  
  # manually install extra dependencies, this is a
  # work-around until https://github.com/pypa/pip/issues/1236 is fixed
  - pip install netCDF4
  
  # spacepy
  - pip install spacepy
  
script:
  - mkdir tmp_for_test
  - cd tmp_for_test
  # run tests and print syslog in case we get killed (to check for out of memory)
  - nosetests --verbosity=3 --nocapture -a '!slow' ../auromat/test ;
    RETVAL=$? ;
    if [ $RETVAL -ne 0 ]; then
      if [ $RETVAL -eq 137 ]; then
        sudo tail -n 100 /var/log/syslog ;
      fi ;
      return $RETVAL ;
    fi 
  - cd ..
  
